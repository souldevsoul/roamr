generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// Roamr eSIM Platform

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?
  image         String?
  role          UserRole  @default(USER)
  credits       Int       @default(0) // Wallet balance in cents
  referralCode  String    @unique @default(cuid())
  referredBy    String?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  orders              Order[]
  esims               ESim[]
  walletTransactions  WalletTransaction[]
}

enum UserRole {
  USER
  ADMIN
}

model WalletTransaction {
  id            String              @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Int                 // In cents (positive for credits, negative for debits)
  balance       Int                 // Balance after transaction
  description   String
  referenceId   String?             // Order ID or payment reference
  status        TransactionStatus   @default(PENDING)
  createdAt     DateTime            @default(now())

  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum TransactionType {
  TOPUP       // Adding funds via payment
  PURCHASE    // Spending on eSIM
  REFUND      // Refund from cancelled order
  BONUS       // Promotional credit
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model Order {
  id            String      @id @default(cuid())
  userId        String
  status        OrderStatus @default(PENDING)
  total         Int         // In cents
  currency      String      @default("USD")
  promoCode     String?
  discount      Int         @default(0)

  country       String
  countryName   String
  planName      String
  dataAmount    String
  validity      Int         // Days

  stripePaymentId String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  esim          ESim?
}

model ESim {
  id            String      @id @default(cuid())
  userId        String
  orderId       String      @unique

  iccid         String      @unique
  qrCode        String      @db.Text
  activationCode String?

  status        ESimStatus  @default(INACTIVE)
  dataUsed      BigInt      @default(0) // In bytes
  dataLimit     BigInt      // In bytes
  expiresAt     DateTime
  activatedAt   DateTime?

  country       String
  countryName   String
  planName      String

  // Gift tracking
  isGifted      Boolean     @default(false)
  giftedToEmail String?
  giftedToName  String?
  giftMessage   String?
  giftedAt      DateTime?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model PromoCode {
  id            String    @id @default(cuid())
  code          String    @unique
  discount      Int       // Percentage (10 = 10%)
  maxUses       Int?
  usedCount     Int       @default(0)
  validFrom     DateTime  @default(now())
  validUntil    DateTime?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
}

enum OrderStatus {
  PENDING
  PAID
  COMPLETED
  FAILED
  REFUNDED
}

enum ESimStatus {
  INACTIVE
  ACTIVE
  EXPIRED
  DEPLETED
}

// Admin settings for markup and configuration
model Settings {
  id            String    @id @default("default")

  // Markup configuration (percentage)
  markupPercent Int       @default(30) // 30% markup on base price

  // Regional markup overrides (JSON: { "JP": 25, "US": 20 })
  regionalMarkup String?  @db.Text

  // Minimum order value in cents
  minOrderValue Int       @default(100) // $1.00

  // Free data threshold (orders above get bonus data)
  freeDataThreshold Int   @default(5000) // $50.00
  freeDataBonus     Int   @default(500)  // 500MB bonus

  // Referral settings
  referralBonus     Int   @default(500)  // $5.00 credit for referrer
  refereeBonus      Int   @default(200)  // $2.00 credit for referee

  // Business info for invoices/PDFs
  businessName    String?   @default("Roamr")
  businessAddress String?   @default("123 Travel Way, Explorer City, EX 10001")
  businessEmail   String?   @default("support@roamr.co")
  businessPhone   String?   @default("+1 (555) 987-6543")
  businessVAT     String?   // VAT/Tax ID number
  invoicePrefix   String?   @default("ROAMR")
  invoiceFooter   String?   @default("Thank you for traveling with ROAMR!")

  // Telegram integration
  telegramBotToken String?
  telegramChatId   String?

  updatedAt     DateTime  @updatedAt
  updatedBy     String?   // Admin user ID who last updated
}

// Admin audit log for tracking changes
model AdminAuditLog {
  id            String    @id @default(cuid())
  adminId       String
  action        String    // CREATE, UPDATE, DELETE
  entity        String    // User, Order, Settings, etc.
  entityId      String?
  changes       String?   @db.Text // JSON of changes
  ipAddress     String?
  createdAt     DateTime  @default(now())

  @@index([adminId, createdAt])
  @@index([entity, entityId])
}
